name: Company Analysis Daily

on:
  workflow_dispatch:
    inputs:
      target_spreadsheet_id:
        description: "Google Spreadsheet ID (optional)"
        required: false
        default: ""
      force_reanalyze:
        description: "Ignore 뉴스수집!A2 check and force run (true/false)"
        required: false
        default: "false"
  schedule:
    # 00:00 KST = 15:00 UTC (previous day)
    - cron: "0 15 * * *"

concurrency:
  group: company-analysis-daily
  cancel-in-progress: false

jobs:
  run-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      DART_API_KEY: ${{ secrets.DART_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
      NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
      GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      GOOGLE_TOKEN_JSON: ${{ secrets.GOOGLE_TOKEN_JSON }}
      GOOGLE_CREDENTIALS_PATH: credentials.json
      GOOGLE_TOKEN_PATH: token.json
      TARGET_SPREADSHEET_ID: ${{ github.event.inputs.target_spreadsheet_id }}
      FORCE_REANALYZE: ${{ github.event.inputs.force_reanalyze }}
      WP_URL: ${{ secrets.WP_URL }}
      WP_USERNAME: ${{ secrets.WP_USERNAME }}
      WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Write Google auth files from secrets
        run: |
          python - <<'PY'
          import os
          from pathlib import Path

          creds = os.environ.get("GOOGLE_CREDENTIALS_JSON", "").strip()
          token = os.environ.get("GOOGLE_TOKEN_JSON", "").strip()

          if creds:
              Path("credentials.json").write_text(creds, encoding="utf-8")
          if token:
              Path("token.json").write_text(token, encoding="utf-8")
          PY

      - name: Run analysis
        run: python main.py
